```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>çš‡å®¶å…¸ç± (V17.2 å®Œç¾ä¿®å¤ç‰ˆ)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;700&family=Inter:wght@400;500;700&family=Noto+Sans+SC:wght@400;500;700&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
<style>
    /* --- [ 1. çš‡å®¶å…¸ç± æ—¥å¸¸ UI CSS (V17) ] --- */
    :root {
        --parchment-bg: #F5E8C8;
        --parchment-texture: linear-gradient(rgba(245, 232, 200, 0.9), rgba(222, 184, 135, 0.95));
        --parchment-darker: #C8B59A;
        --content-bg: #FFFBF0;
        --text-color: #6D4C41;
        --heading-color: #4E342E;
        --secondary-text: #A1887F;
        --accent-gold: #C0952A;
        --accent-gold-light: #E0B85F;
        --accent-pink: #D81B60;
        --accent-purple: #8E24AA; /* æ–°å¢ï¼šç”¨äºå†…å¿ƒæƒ³æ³•/è®°å¿† */
        --icon-color: #6D4C41;
        --border-color: rgba(109, 76, 65, 0.3);
        --shadow-color: rgba(74, 44, 19, 0.4);
        --stamina-color: #9CCC65;
        --hp-color: #EF9A9A;
        --mp-color: #90CAF9;
        --combat-red: #B71C1C;
    }
    
    body {
        background-color: var(--text-color);
        background-image: var(--parchment-texture);
        color: var(--text-color);
        font-family: 'Inter', 'Noto Sans SC', sans-serif;
        margin: 0;
        font-size: 14px;
        line-height: 1.6;
    }
    body.status-mode { padding: 15px 10px; }
    body.combat-mode { padding: 0; }

    ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); } ::-webkit-scrollbar-thumb { background: var(--accent-gold); border-radius: 3px; border: 1px solid var(--parchment-bg); }
    
    #chessboard-container-wrapper {
        max-width: 900px; margin: 10px auto; 
        border: 2px solid var(--heading-color); 
        border-radius: 8px; 
        background: var(--parchment-bg); 
        box-shadow: 0 3px 12px var(--shadow-color), inset 0 0 10px rgba(74, 44, 19, 0.25); 
        padding: 10px; position: relative; z-index: 1;
    }
    .hidden { display: none !important; }
    h2, h3, h4, details > summary { font-family: 'EB Garamond', 'Noto Sans SC', serif; font-weight: 700; color: var(--heading-color); text-shadow: 1px 1px 1px rgba(255, 255, 255, 0.7); margin-top: 0; margin-bottom: 8px; }
    h2 { font-size: 1.5em; margin-bottom: 15px; text-align: center; } 
    h3 { font-size: 1.25em; } h4 { font-size: 1.1em; } 
    h3::before, h4::before { content: 'â€¢'; color: var(--accent-gold); margin-right: 6px; font-size: 0.8em; vertical-align: middle; }
    .empty-state-text { color: var(--secondary-text); text-align: center; padding: 10px; font-style: normal; opacity: 0.8; font-size: 0.9em; }
    .property-name { color: var(--secondary-text); font-weight: 500; font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.5px; }
    .value-main { color: var(--text-color); font-weight: 600; font-size: 0.95em; }
    details.section { background: rgba(255, 255, 255, 0.15); border: none; border-radius: 8px; margin-bottom: 10px; overflow: hidden; transition: background-color 0.3s ease; box-shadow: inset 0 0 0 1px rgba(109, 76, 65, 0.1); }
    details[open].section { background-color: rgba(255, 255, 255, 0.3); } 
    details > summary { display: flex; justify-content: flex-start; align-items: center; list-style: none; padding: 10px 15px; cursor: pointer; font-size: 1.2em; position: relative; border-bottom: 1px solid transparent; transition: border-color 0.3s ease; } 
    details.section > summary::before { content: none; } 
    .summary-icon { color: var(--accent-gold); margin-right: 12px; font-size: 1em; opacity: 0.9; width: 1.2em; text-align: center; } 
    details > summary::-webkit-details-marker { display: none; } 
    .arrow-toggle { transition: transform 0.3s ease; margin-left: auto; font-size: 0.8em; color: var(--secondary-text); } 
    details[open] > summary .arrow-toggle { transform: rotate(90deg); } 
    details[open] > summary { border-bottom-color: var(--border-color); }
    .section-content { padding: 15px; background-color: var(--content-bg); border-top: none; position: relative; background-image: linear-gradient(45deg, rgba(109, 76, 65, 0.03) 25%, transparent 25%, transparent 75%, rgba(109, 76, 65, 0.03) 75%, rgba(109, 76, 65, 0.03)), linear-gradient(-45deg, rgba(109, 76, 65, 0.03) 25%, transparent 25%, transparent 75%, rgba(109, 76, 65, 0.03) 75%, rgba(109, 76, 65, 0.03)); background-size: 20px 20px; }
    .section-content::before { content: ''; position: absolute; top: 0; left: 15px; right: 15px; height: 1px; background-image: linear-gradient(to right, transparent, var(--accent-gold) 30%, var(--accent-gold) 70%, transparent); opacity: 0.5; }
    details.sub-section { background: rgba(0, 0, 0, 0.03); border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 8px; overflow: hidden; transition: background-color 0.2s ease; } 
    details.sub-section:hover { background-color: rgba(0, 0, 0, 0.06); } 
    details[open].sub-section { border-color: var(--accent-gold); } 
    details.sub-section > summary { font-size: 1em; padding: 8px 12px; position: relative; display: flex; align-items: center; font-family: 'Inter', 'Noto Sans SC', sans-serif; font-weight: 600; } 
    details.sub-section > summary::before { content: none; } 
    details.sub-section > summary::after { content: 'âˆ'; color: var(--secondary-text); font-size: 0.7em; opacity: 0.6; margin-left: 8px; order: 1; } 
    details.sub-section.is-redline > summary { border-left: 3px solid var(--accent-pink); padding-left: 9px; } 
    .sub-section-content { padding: 10px 12px; } 
    .sub-section-content p { margin: 4px 0; line-height: 1.5; font-size: 0.9em; } 
    .sub-section-content p b { color: var(--secondary-text); margin-right: 4px; font-weight: 600; }
    hr { border: none; height: 1px; background-image: linear-gradient(to right, rgba(109, 76, 65, 0.1) 0%, rgba(109, 76, 65, 0.4) 30%, var(--accent-gold) 50%, rgba(109, 76, 65, 0.4) 70%, rgba(109, 76, 65, 0.1) 100%); opacity: 0.8; margin: 12px 0; }
    .world-info-box { display: grid; grid-template-columns: 1fr; gap: 8px; background-color: rgba(0,0,0,0.05); padding: 10px; border-radius: 6px; margin-bottom: 12px; border: 1px solid var(--border-color); box-shadow: inset 0 0 5px rgba(0,0,0,0.05); } 
    .world-info-box > div { border-bottom: 1px dotted var(--border-color); padding-bottom: 5px; margin-bottom: 5px; } 
    .world-info-box > div:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; } 
    .world-info-box p { margin: 2px 0; } 
    @media (min-width: 600px) { .world-info-box { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); } .world-info-box > div { border-bottom: none; border-right: 1px dotted var(--border-color); padding-bottom: 0; margin-bottom: 0; padding-right: 10px; margin-right: 10px; } .world-info-box > div:last-child { border-right: none; margin-right: 0; padding-right: 0; } }
    .progress-bar-container { background-color: rgba(0,0,0,0.1); border-radius: 8px; height: 8px; padding: 1px; box-shadow: inset 0 1px 2px rgba(0,0,0,0.3); overflow: hidden; position: relative; flex-grow: 1; border: 1px solid rgba(0,0,0,0.1); } 
    .progress-bar-value { height: 100%; border-radius: 6px; transition: width 0.5s ease; background: linear-gradient(to right, var(--accent-gold), var(--accent-gold-light)); box-shadow: inset 0 1px 1px rgba(255,255,255,0.4), inset 0 -1px 1px rgba(0,0,0,0.15); } 
    #main-hp-bar { background: linear-gradient(to right, var(--hp-color), #F48FB1); } 
    #main-mp-bar { background: linear-gradient(to right, var(--mp-color), #90CAF9); } 
    #main-sp-bar { background: linear-gradient(to right, var(--stamina-color), #AED581); }
    .item-row { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 10px; padding: 8px 0; border-radius: 0; transition: background-color 0.2s; position: relative; border-bottom: 1px dotted var(--border-color); } 
    .item-row:last-child { border-bottom: none; } .item-row:hover { background-color: rgba(0, 0, 0, 0.03); } .item-row > div:first-child { padding-left: 0; } .item-row .value-main { text-align: right; font-size: 0.9em; } .item-row small { font-size: 0.85em; opacity: 0.8; color: var(--secondary-text); }
    .map-location { display: flex; align-items: center; gap: 10px; cursor: default; padding: 8px 5px; border-radius: 4px; transition: background-color 0.2s; position: relative; border-bottom: 1px dotted var(--border-color); } 
    .map-location:last-child { border-bottom: none; } .map-location:hover { background-color: rgba(0, 0, 0, 0.03); } .map-location::before { content: 'ğŸ“œ'; color: var(--accent-gold); opacity: 0.8; margin-right: 5px; font-size: 0.9em; } .location-text { flex-grow: 1; font-size: 0.9em; } .location-text b { font-weight: 600; } .location-text small { font-size: 0.9em; color: var(--secondary-text); }
    .action-button, .filter-btn { background-color: rgba(255, 255, 255, 0.3); border: 1px solid var(--border-color); color: var(--text-color); padding: 6px 12px; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; font-size: 0.9em; font-family: 'Inter', 'Noto Sans SC', sans-serif; box-shadow: 0 1px 3px rgba(0,0,0,0.15); text-shadow: none; min-width: 70px; text-align: center; line-height: 1.4; } 
    .action-button i, .filter-btn i { margin-right: 6px; opacity: 0.8; font-size: 0.9em; } 
    .action-button:hover, .filter-btn:hover { background-color: rgba(255, 255, 255, 0.5); border-color: var(--accent-gold); color: var(--heading-color); box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-weight: 600; transform: translateY(-1px); } 
    .filter-btn.active { background-color: var(--accent-gold); color: var(--content-bg); border-color: var(--accent-gold); font-weight: 600; box-shadow: inset 0 1px 2px rgba(0,0,0,0.2); transform: none; }
    .detail-grid { display: grid; grid-template-columns: 1fr; gap: 8px; } 
    @media (min-width: 480px) { .attributes-grid { grid-template-columns: 1fr 1fr; } } .detail-grid-item { display: grid; grid-template-columns: 20px auto 1fr; align-items: center; gap: 8px; padding-bottom: 8px; border-bottom: 1px dotted rgba(109, 76, 65, 0.3); } 
    .detail-grid-item:last-child { border-bottom: none; } .detail-grid-item .icon { color: var(--icon-color); text-shadow: none; text-align: center; font-size: 1em; width: 20px; flex-shrink: 0; opacity: 0.8; } .detail-grid-item .value-main { text-align: right; font-size: 0.95em; } .resource-row .icon { text-shadow: 0 0 6px rgba(255, 255, 255, 0.7); opacity: 1; } .resource-grid-item { display: flex; align-items: center; gap: 8px; padding-bottom: 8px; border-bottom: 1px dotted rgba(109, 76, 65, 0.3); } .resource-row { display: flex; align-items: center; gap: 8px; flex-grow: 1; } .resource-row .value-main { font-size: 0.9em; white-space: nowrap; }
    /* æ–°å¢ï¼šç”¨äºé•¿æ–‡æœ¬æè¿°ï¼ˆå¦‚è‚‰ä½“æå†™ï¼‰ */
    .long-text-block { background: rgba(0,0,0,0.03); padding: 8px; border-radius: 4px; margin-top: 4px; font-size: 0.9em; border: 1px solid rgba(109, 76, 65, 0.1); }
    /* æ–°å¢ï¼šå†…å¿ƒæƒ³æ³•æ ·å¼ */
    .inner-thought-block { background: rgba(142, 36, 170, 0.05); border-left: 3px solid var(--accent-purple); padding: 8px; margin: 5px 0; font-style: italic; font-size: 0.9em; color: var(--text-color); }
    .erotic-tag { color: var(--accent-pink); font-size: 0.8em; border: 1px solid var(--accent-pink); padding: 1px 4px; border-radius: 4px; margin-right: 5px; }
    
    .currency-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 6px; } 
    .currency-item { display: flex; align-items: center; background-color: rgba(0,0,0,0.05); padding: 5px 8px; border-radius: 6px; border: 1px solid var(--border-color); } 
    .currency-icon { font-size: 1.1em; margin-right: 6px; width: 18px; text-align: center; } .currency-info .property-name { font-size: 0.7em; } .currency-info .value-main { font-size: 0.95em; } 
    .icon-gold, .icon-platinum, .icon-crystal { color: var(--accent-gold); } .icon-silver { color: #A0A0A0; } .icon-copper { color: #A05A2C; } .icon-bone { color: #CEC8B7; } .tag { background-color: var(--secondary-text); color: var(--content-bg); padding: 1px 5px; border-radius: 4px; font-size: 0.7em; font-weight: normal; margin-left: 4px; display: inline-block; white-space: nowrap; }
    .char-favor-bar-container { background-color: rgba(0,0,0,0.1); border-radius: 5px; height: 6px; overflow:hidden; border: 1px solid var(--border-color); padding: 1px; } 
    .char-favor-bar { background: var(--accent-gold); height: 100%; border-radius: 3px; transition: width 0.5s ease; box-shadow: none; }
    .memory-entry { background: rgba(0,0,0,0.03); border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 6px; } 
    .memory-entry[open] { box-shadow: none; border-color: var(--accent-gold); } .memory-entry > summary { font-size: 0.9em; padding: 6px 10px; font-family: 'Inter', 'Noto Sans SC', sans-serif; font-weight: 500; } 
    .memory-content { padding: 0 10px 10px 10px; line-height: 1.5; color: var(--text-color); font-size: 0.85em; opacity: 0.9; } .memory-content p { margin-top: 5px; }
    .protagonist-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 10px; overflow-x: auto; } 
    .protagonist-tab { padding: 8px 12px; cursor: pointer; background-color: transparent; border: 1px solid transparent; border-bottom: none; border-radius: 6px 6px 0 0; margin-right: 2px; color: var(--secondary-text); font-family: 'EB Garamond', serif; font-weight: 700; font-size: 1.05em; transition: all 0.2s ease; text-shadow: none; position: relative; white-space: nowrap; } 
    .protagonist-tab:hover { color: var(--accent-gold); } 
    .protagonist-tab.active { color: var(--accent-gold); background-color: var(--content-bg); border-color: var(--border-color); border-bottom-color: var(--content-bg); margin-bottom: -1px; } 
    .protagonist-tab.active::after { content: ''; position: absolute; bottom: 0px; left: 15%; width: 70%; height: 2px; background-color: var(--accent-gold); border-radius: 1px; } 
    .protagonist-tab-content { padding: 15px; background-image: linear-gradient(45deg, rgba(109, 76, 65, 0.03) 25%, transparent 25%, transparent 75%, rgba(109, 76, 65, 0.03) 75%, rgba(109, 76, 65, 0.03)), linear-gradient(-45deg, rgba(109, 76, 65, 0.03) 25%, transparent 25%, transparent 75%, rgba(109, 76, 65, 0.03) 75%, rgba(109, 76, 65, 0.03)); background-size: 20px 20px; }
    .fp-value { font-weight: 700; color: var(--accent-gold-light); text-shadow: 0 0 5px rgba(224, 184, 95, 0.6); font-size: 1.1em; }
    /* --- [ End of Daily UI CSS ] --- */


    /* --- [ 2. æˆ˜æ–— UI v15 (é­”å°æ›¸ãƒ»è–æˆ¦ç‰ˆ by Konata) ] --- */
    :root { 
        --arcane-bg: #1a1f2e;
        --arcane-panel-bg: rgba(10, 15, 25, 0.6);
        --arcane-border: #3a4a6b;
        --arcane-glow: #76DDFB;
        --arcane-glow-shadow: rgba(118, 221, 251, 0.5);

        --accent-gold-battle: var(--accent-gold);
        --accent-gold-light-battle: var(--accent-gold-light);

        --battle-font-primary: 'Noto Sans SC', sans-serif;
        --battle-font-secondary: 'Cinzel', 'EB Garamond', 'Noto Serif SC', serif; 
        
        --text-light: #E0E8F5;
        --text-dark: #1a1a1a;
        --text-secondary-battle: #8b9bb3;

        --hp-color: #c0392b;
        --hp-color-light: #e74c3c;
        --mp-color: #2980b9;
        --mp-color-light: #3498db;
        --bar-bg: #2b344b;
        --overlay-bg: rgba(26, 31, 46, 0.9);
        --log-bg: rgba(0, 0, 0, 0.3);
    }

    @keyframes pulse-glow-battle {
        0%, 100% { box-shadow: 0 0 20px rgba(192, 149, 42, 0.6), inset 0 0 10px rgba(0, 0, 0, 0.5), 0 0 10px var(--arcane-glow-shadow); }
        50% { box-shadow: 0 0 30px rgba(224, 184, 95, 0.8), inset 0 0 10px rgba(0, 0, 0, 0.5), 0 0 20px var(--arcane-glow-shadow); }
    }
    @keyframes target-lock-pulse {
        0%, 100% { background: rgba(118, 221, 251, 0.1); border-color: var(--arcane-glow); box-shadow: 0 0 10px var(--arcane-glow-shadow); }
        50% { background: rgba(118, 221, 251, 0.2); border-color: #fff; box-shadow: 0 0 20px #fff, 0 0 10px var(--arcane-glow-shadow); }
    }
    @keyframes bar-flow {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(200%); }
    }

    #battle-ui-wrapper {
        max-width: 900px; margin: 10px auto; padding: 12px;
        background-color: var(--arcane-bg);
        background-image: linear-gradient(135deg, rgba(58, 74, 107, 0.3) 0%, rgba(0,0,0,0) 60%),
                          radial-gradient(ellipse at bottom, rgba(192, 149, 42, 0.1) 0%, rgba(0,0,0,0) 70%),
                          linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)),
                          url('https://www.transparenttextures.com/patterns/dark-matter.png');
        border: 2px solid var(--accent-gold-battle); border-radius: 8px;
        font-family: var(--battle-font-primary); color: var(--text-light);
        font-size: 14px; line-height: 1.6; display: flex; flex-direction: column;
        gap: 12px; 
        animation: pulse-glow-battle 5s infinite ease-in-out;
        box-shadow: 0 0 20px rgba(192, 149, 42, 0.6), inset 0 0 10px rgba(0, 0, 0, 0.5);
    }
    #battle-ui-wrapper .combatant-area { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    #battle-ui-wrapper .team {
        display: flex; flex-direction: column; gap: 8px; padding: 10px;
        background: rgba(10,10,15,0.4); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 6px;
    }
    #battle-ui-wrapper .team-title {
        font-family: var(--battle-font-secondary);
        font-weight: 700; font-size: 1.6em; 
        color: var(--accent-gold-light-battle);
        text-align: center; border-bottom: 1px solid var(--accent-gold-battle);
        padding-bottom: 5px; margin-bottom: 5px; text-shadow: 0 0 8px var(--accent-gold-battle);
    }
    #battle-ui-wrapper .combatant-bar {
        padding: 8px 12px; 
        background: var(--arcane-panel-bg);
        border: 1px solid var(--arcane-border);
        border-radius: 4px; cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    #battle-ui-wrapper .combatant-bar:hover { 
        background: rgba(118, 221, 251, 0.1); 
        border-color: var(--arcane-glow);
    }
    #battle-ui-wrapper .combatant-bar.selected { 
        animation: target-lock-pulse 2s infinite ease-in-out;
    }
    #battle-ui-wrapper .combatant-header { display: flex; justify-content: space-between; align-items: center; font-weight: 700; font-size: 1.1em; margin-bottom: 6px; }
    #battle-ui-wrapper .combatant-name { font-family: var(--battle-font-secondary); color: var(--text-light); text-shadow: 1px 1px 2px #000; }
    #battle-ui-wrapper .combatant-type { font-size: 0.8em; color: var(--text-secondary-battle); }
    #battle-ui-wrapper .stat-bars { display: flex; flex-direction: column; gap: 4px; }
    #battle-ui-wrapper .stat-bar { width: 100%; height: 16px; background-color: var(--bar-bg); border: 1px solid #111; border-radius: 3px; position: relative; overflow: hidden; }
    #battle-ui-wrapper .stat-bar-value::before {
        content: ''; position: absolute; top: 0; left: 0; width: 50%; height: 100%;
        background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0) 100%);
        animation: bar-flow 3s infinite linear;
    }
    #battle-ui-wrapper .stat-bar-value { height: 100%; transition: width 0.5s ease; position: absolute; top: 0; left: 0; }
    #battle-ui-wrapper .stat-bar-value.hp { background: linear-gradient(90deg, var(--hp-color) 0%, var(--hp-color-light) 100%); }
    #battle-ui-wrapper .stat-bar-value.mp { background: linear-gradient(90deg, var(--mp-color) 0%, var(--mp-color-light) 100%); }
    #battle-ui-wrapper .stat-bar-text { position: absolute; width: 100%; text-align: center; font-size: 11px; font-weight: 700; color: white; text-shadow: 1px 1px 2px #000, 0 0 3px #000; line-height: 14px; }
    #battle-ui-wrapper .stat-bar-text .label { font-weight: 500; }
    #battle-ui-wrapper .action-panel { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; min-height: 200px; }
    #battle-ui-wrapper .tab-panel { display: flex; flex-direction: column; background: rgba(10,10,15,0.4); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 6px; overflow: hidden; }
    #battle-ui-wrapper .tabs { display: flex; background: var(--arcane-panel-bg); }
    #battle-ui-wrapper .tab-button {
        flex: 1; padding: 10px; background: transparent; border: none; border-bottom: 3px solid transparent;
        color: var(--text-secondary-battle); font-family: var(--battle-font-secondary);
        font-size: 1.2em; font-weight: 700; cursor: pointer; transition: all 0.3s ease;
        text-shadow: 1px 1px 2px #000; 
    }
    #battle-ui-wrapper .tab-button:hover { 
        color: var(--text-light); 
        background: rgba(118, 221, 251, 0.1);
    }
    #battle-ui-wrapper .tab-button.active-tab { 
        color: var(--accent-gold-light-battle);
        border-bottom-color: var(--accent-gold-battle);
        background: rgba(0,0,0,0.2); 
    }
    #battle-ui-wrapper #tab-content-area { padding: 10px; height: 160px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
    #battle-ui-wrapper .action-item-button {
        display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 8px 12px;
        background: #2b344b;
        border: 1px solid var(--arcane-border);
        border-radius: 4px;
        color: var(--text-light); cursor: pointer; transition: all 0.3s ease; text-align: left;
    }
    #battle-ui-wrapper .action-item-button:hover { 
        background: rgba(118, 221, 251, 0.15);
        border-color: var(--arcane-glow); 
    }
    #battle-ui-wrapper .action-item-name { font-weight: 700; font-size: 1.05em; }
    #battle-ui-wrapper .action-item-cost { font-size: 0.9em; color: var(--mp-color-light); font-weight: 500; }
    #battle-ui-wrapper .action-item-count { font-size: 0.9em; color: var(--text-secondary-battle); font-weight: 500; }
    #battle-ui-wrapper .action-item-desc { font-size: 0.85em; color: var(--text-secondary-battle); width: 100%; margin-top: 4px; }
    #battle-ui-wrapper .core-actions { display: flex; flex-direction: column; gap: 8px; }
    #battle-ui-wrapper .core-action-button {
        width: 100%; height: 100%; padding: 15px;
        font-family: var(--battle-font-secondary); font-size: 1.4em; font-weight: 700;
        background-image: linear-gradient(rgba(255,255,255,0.05), rgba(0,0,0,0.1));
        background-color: rgba(10, 15, 25, 0.6);
        color: var(--text-light);
        border: 2px solid var(--arcane-border);
        border-radius: 6px; cursor: pointer; transition: all 0.3s ease;
        box-shadow: 0 2px 5px rgba(0,0,0,0.5), inset 0 1px 1px rgba(255, 255, 255, 0.1);
        text-shadow: 0 0 5px var(--arcane-glow-shadow); 
    }
    #battle-ui-wrapper .core-action-button:hover {
        background-color: rgba(118, 221, 251, 0.2); 
        color: white;
        border-color: var(--arcane-glow);
        box-shadow: 0 0 10px var(--arcane-glow), 0 0 15px var(--arcane-glow-shadow), inset 0 1px 1px rgba(255, 255, 255, 0.3);
    }
    #battle-ui-wrapper .pre-input-area { display: flex; flex-direction: column; gap: 8px; }
    #battle-ui-wrapper #pre-input-bar { 
        width: 100%; min-height: 60px; 
        background: var(--log-bg);
        border: 1px solid var(--arcane-border); 
        border-radius: 4px; color: var(--text-light); 
        font-family: var(--battle-font-primary); font-size: 1em; padding: 8px; resize: vertical; 
    }
    #battle-ui-wrapper #start-turn-button {
        width: 100%; padding: 12px; font-family: var(--battle-font-secondary);
        font-size: 1.5em; font-weight: 700; 
        background: var(--accent-gold-battle); 
        color: var(--text-dark);
        border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease;
        box-shadow: 0 0 15px var(--accent-gold-battle);
    }
    #battle-ui-wrapper #start-turn-button:hover { 
        background: var(--accent-gold-light-battle); 
        color: #000; 
        box-shadow: 0 0 25px var(--accent-gold-light-battle); 
    }
    #battle-ui-wrapper .battle-log-area { 
        height: 150px; 
        background: var(--log-bg);
        border: 1px solid var(--arcane-border); 
        border-radius: 6px; padding: 12px; overflow-y: auto; 
        white-space: pre-line; font-size: 0.9em; color: var(--text-light); 
    }
    #battle-ui-wrapper #end-battle-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: var(--overlay-bg); display: flex; justify-content: center; align-items: center; z-index: 100; }
    #battle-ui-wrapper #end-battle-button {
        padding: 20px 40px; font-family: var(--battle-font-secondary);
        font-size: 2em; font-weight: 700; 
        background: var(--accent-gold-battle); 
        color: var(--text-dark);
        border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;
        box-shadow: 0 0 20px var(--accent-gold-battle);
    }
    #battle-ui-wrapper #end-battle-button:hover { background: var(--accent-gold-light-battle); color: #000; transform: scale(1.05); }
    /* --- [ End of Battle UI v15 ] --- */
</style>
</head>
<body class="status-mode">
    <div id="chessboard-container-wrapper">
        </div>

    
    <div id="battle-ui-wrapper" class="hidden">
        <div class="combatant-area">
            <div class="team" id="player-combatants-area">
                <div class="team-title">å…‰ã®ç›Ÿå‹</div>
                <p id="player-combatants-placeholder" class="empty-state-text">(ç­‰å¾…ç›Ÿå‹å“åº”å¬å”¤...)</p>
            </div>
            <div class="team" id="enemy-combatants-area">
                <div class="team-title">æ·±æ·µã®æ•µ</div>
                <p id="enemy-combatants-placeholder" class="empty-state-text">(ä¾¦æµ‹åˆ°æ·±æ¸Šæ³¢åŠ¨...)</p>
            </div>
        </div>
        <div class="action-panel">
            <div class="tab-panel">
                <div class="tabs">
                    <button id="tab-btn-skills" class="tab-button" onclick="window.battle_ui_events.selectTab('skills')">
                        <i class="fa-solid fa-magic-wand-sparkles"></i> å¥¥ç¾©
                    </button>
                    <button id="tab-btn-bags" class="tab-button" onclick="window.battle_ui_events.selectTab('bags')">
                        <i class="fa-solid fa-sack"></i> æ¬¡å…ƒè¢‹
                    </button>
                </div>
                <div id="tab-content-area">
                    <p class="empty-state-text">(è¯·æŒ‡å®šå’å”±è€…...)</p>
                </div>
            </div>
            <div class="core-actions">
                
                <button class="core-action-button" onclick="window.battle_ui_events.coreAction('æ”»å‡»')">
                    <i class="fa-solid fa-khanda"></i> æ–¬æ’ƒ
                </button>
                <button class="core-action-button" onclick="window.battle_ui_events.coreAction('é˜²å¾¡')">
                    <i class="fa-solid fa-shield-halved"></i> å®ˆè­·
                </button>
                <button class="core-action-button" onclick="window.battle_ui_events.coreAction('é€ƒè·‘')">
                    <i class="fa-solid fa-person-running"></i> è»¢ç§»
                </button>
            </div>
        </div>
        <div class="pre-input-area">
            <textarea id="pre-input-bar" placeholder="é­”å°æ›¸ã«ãƒ«ãƒ¼ãƒ³ã‚’åˆ»ã‚€..."></textarea>
            <button id="start-turn-button" onclick="window.battle_ui_events.startTurn()">
                <i class="fa-solid fa-play"></i> é‹å‘½ã‚’ç´¡ã
            </button>
        </div>
        <div class="battle-log-area" id="battle-log-content">
            (æˆ¦ã„ã®å™äº‹è©©ãŒè¨˜ã•ã‚Œã‚‹...)
        </div>
        <div id="end-battle-overlay" class="hidden">
            <button id="end-battle-button" onclick="window.battle_ui_events.endBattle()">
                <i class="fa-solid fa-flag-checkered"></i> å‡±æ—‹
            </button>
        </div>
    </div>
    

<script>
    (function() {
        if (window.MASTER_UI_INITIALIZED) return;
        window.MASTER_UI_INITIALIZED = true;
        console.log("--- [çš‡å®¶å…¸ç± V17.2] è„šæœ¬åˆå§‹åŒ– (å·²ä¿®å¤ //reason æ˜¾ç¤ºé—®é¢˜ & ä»»åŠ¡è½¯åˆ é™¤) ---"); 

        // --- [ 1. GLOBAL HELPERS ] ---
        window.last_stat_data = {}; 
        
        let selectedParticipantKey = 'player'; 
        let currentCombatTab = 'skills'; 

        let currentInventoryFilter = 'å…¨éƒ¨';
        let currentProtagonistTab = 'core'; 
        
        const isObject = (item) => (item && typeof item === 'object' && !Array.isArray(item));
        
        const setToggle = (id, visible) => {
            const el = document.getElementById(id);
            if (el) el.classList.toggle('hidden', !visible);
        };
        
        // ã€ä¿®æ­£ 1ã€‘DeepMerge ç°åœ¨ä¼šæ­£ç¡®è·³è¿‡ //reasonï¼Œå¹¶ä¸”å…è®¸ null å€¼è¦†ç›– (ç”¨äºä»»åŠ¡åˆ é™¤)
        const deepMerge = (target, source) => {
            let output = Object.assign({}, target);
            if (isObject(target) && isObject(source)) {
                Object.keys(source).forEach(key => {
                    if (key === '$meta' || key === '//reason') return; // è¿‡æ»¤ //reason
                    if (isObject(source[key])) {
                        if (!(key in target) || !isObject(target[key])) { Object.assign(output, { [key]: source[key] }); } 
                        else { output[key] = deepMerge(target[key], source[key]); }
                    } else { Object.assign(output, { [key]: source[key] }); }
                });
            }
            return output;
        };
        
        const SafeGetValue = (obj, path, defaultValue) => {
            try {
                const keys = path.split('.');
                let current = obj;
                for (let i = 0; i < keys.length; i++) {
                    const key = keys[i];
                    if (current === null || typeof current !== 'object') { return defaultValue; }
                    const match = key.match(/^(.+?)\[(\d+)\]$/);
                    if (match) {
                        const arrayKey = match[1];
                        const index = parseInt(match[2], 10);
                        if (current.hasOwnProperty(arrayKey) && Array.isArray(current[arrayKey]) && index >= 0 && index < current[arrayKey].length) {
                            current = current[arrayKey][index];
                        } else { return defaultValue; }
                    } else if (current.hasOwnProperty(key)) {
                        current = current[key];
                    } else { return defaultValue; }
                }
                return current === undefined ? defaultValue : current;
            } catch (error) {
                console.error(`SafeGetValue CRITICAL ERROR for path "${path}" in obj:`, obj, 'Error:', error);
                return defaultValue;
            }
        };

        const royal_updateProgressBar = (barId, current, max, color, shadowColor = null) => { 
            const bar = document.getElementById(barId); 
            if (bar) { 
                const percentage = max > 0 ? (current / max) * 100 : 0; 
                bar.style.width = `${Math.max(0, Math.min(100, percentage))}%`; 
            } 
        };
        
        const setContent = (id, content) => { const el = document.getElementById(id); if (el) el.innerHTML = content; };

        const defaultEmptyState = {
          "UIçŠ¶æ€": { "å½“å‰ç•Œé¢": [ "æ—¥å¸¸", ""] },
          "æˆ˜æ–—çŠ¶æ€": [ { "in_combat": [ false, "" ], "enemies": {}, "allies": {}, "combat_log": [] } ],
          "ä¸»è§’": { "å§“å": [ "<user>", "" ], "åŠ›é‡å±‚æ¬¡": [ "(æœªå®šä¹‰)", "" ], "èµ„æº": {}, "è£…å¤‡": [], "çŠ¶æ€æ•ˆæœ": [], "æŠ€èƒ½": [], "æ€§çˆ±ç»Ÿè®¡": [{"æ˜¯å¦å¤„ç”·":[true, ""], "äº¤åˆæ¬¡æ•°":[0, ""], "æ€§ç™–":[]}] },
          "ä¸–ç•Œ": { "æ—¶é—´": [ "(æœªè®¾å®š)", "" ], "åœ°ç‚¹": [ "(æœªçŸ¥)", "" ], "é‚»è¿‘åœ°ç‚¹": [], "å¤©æ°”": [ "æ— ", "" ], "å½“å‰å£°æœ›": [ 0, "" ] },
          "äººè„‰å…³ç³»": [ {} ],
          "ä»»åŠ¡åˆ—è¡¨": [ {} ],
          "è´¢äº§": { "è´§å¸": {}, "èƒŒåŒ…": [] },
          "å‘½è¿ç³»ç»Ÿ": { "å‘½è¿ç‚¹æ•°": [ 0, "" ], "çº¢çº¿å¯¹è±¡": [ {} ] },
          "ä»Šæ—¥æ–°é—»": { "é‡‘ç‹®å¿«è®¯": [ "" ], "é…’é¦†ç•™è¨€æ¿": [ "" ], "ä¸–ç•ŒçœŸå¥‡å¦™": [ "" ], "è‰è‰ä¸çš„åˆåèŒ¶ä¼š": [ "" ] },
          "ä¸–ç•Œå›¾é‰´": [ {} ]
        };


        // --- [ 2. MVU äº¤äº’åŠ©æ‰‹ ] ---
        window.SillyTavern_MVU_Set = (path, old_val, new_val, comment = "UI: Set") => {
            if (typeof Mvu === 'undefined') return console.error("[MasterUI] Mvu not found!");
            Mvu.setVariable(path, old_val, new_val, comment);
        };
        window.SillyTavern_TriggerSlash = (command) => {
            if (typeof triggerSlash === 'function') {
                triggerSlash(command);
            } else {
                alert(`Error: triggerSlash function not found. Cannot send command:\n${command}`);
            }
        };

        // --- [ 3. æ—¥å¸¸ UI æ¸²æŸ“å™¨ (V17 Updated) ] ---
        
        function renderStatusUI(data) { 
            const container = document.getElementById('chessboard-container-wrapper'); 
            if (!container) return;
            container.className = 'status-container'; 
            
            const sectionIcons = { 'ä¸»è§’': 'fa-book-skull', 'æ¢ç´¢é™„è¿‘': 'fa-compass', 'äººè„‰å…³ç³»': 'fa-users-viewfinder', 'å‘½è¿ç³»ç»Ÿ': 'fa-hands-holding-circle', 'å½“å‰ä»»åŠ¡': 'fa-scroll', 'è´¢äº§': 'fa-gem', 'ä»Šæ—¥æ–°é—»': 'fa-newspaper', 'ä¸–ç•Œå›¾é‰´': 'fa-atlas' }; 
            const sectionOrder = ['ä¸»è§’', 'æ¢ç´¢é™„è¿‘', 'äººè„‰å…³ç³»', 'å‘½è¿ç³»ç»Ÿ', 'å½“å‰ä»»åŠ¡', 'è´¢äº§', 'ä»Šæ—¥æ–°é—»', 'ä¸–ç•Œå›¾é‰´']; 
            let sectionsHtml = sectionOrder.map(title => { const iconClass = sectionIcons[title] || 'fa-question-circle'; const sectionId = { 'ä¸»è§’': 'protagonist-section', 'æ¢ç´¢é™„è¿‘': 'map-section', 'äººè„‰å…³ç³»': 'contacts-section', 'å‘½è¿ç³»ç»Ÿ': 'destiny-section', 'å½“å‰ä»»åŠ¡': 'tasks-section', 'è´¢äº§': 'assets-section', 'ä»Šæ—¥æ–°é—»': 'news-section', 'ä¸–ç•Œå›¾é‰´': 'codex-section' }[title]; const contentPadding = (title === 'ä¸»è§’') ? 'padding: 5px 15px 15px 15px;' : ''; return `<details class="section"> <summary><i class="fa-solid ${iconClass} fa-fw summary-icon"></i>${title}<span class="arrow-toggle">&gt;</span></summary> <div class="section-content" id="${sectionId}" style="${contentPadding}"></div> </details>`; }).join(''); 
            container.innerHTML = `<div class="world-info-box" id="world-info-box"></div> ${sectionsHtml}`; 
            
            const worldData = SafeGetValue(data, 'ä¸–ç•Œ', {}); 
            populateWorldInfo(worldData); 
            populateProtagonist(SafeGetValue(data, 'ä¸»è§’', {})); 
            populateMap(worldData); 
            populateDestinyAndContacts(data); 
            const tasksContainer = SafeGetValue(data, 'ä»»åŠ¡åˆ—è¡¨', []); 
            const tasksData = Array.isArray(tasksContainer) && tasksContainer.length > 0 ? tasksContainer[0] : {}; 
            populateQuests(tasksData); 
            populateAssets(SafeGetValue(data, 'è´¢äº§', {})); 
            populateNews(SafeGetValue(data, 'ä»Šæ—¥æ–°é—»', {})); 
            populateCodex(SafeGetValue(data, 'ä¸–ç•Œå›¾é‰´', [])); 
        }
        function populateWorldInfo(worldData) { setContent('world-info-box', ` <div><p><span class="property-name"><i class="fa-solid fa-clock icon"></i> æ—¶é—´:</span> <span class="value-main">${SafeGetValue(worldData, 'æ—¶é—´[0]', 'æœªçŸ¥')}</span></p></div> <div><p><span class="property-name"><i class="fa-solid fa-map-location-dot icon"></i> åœ°ç‚¹:</span> <span class="value-main">${SafeGetValue(worldData, 'åœ°ç‚¹[0]', 'æœªçŸ¥')}</span></p></div> <div><p><span class="property-name"><i class="fa-solid fa-cloud-sun icon"></i> å¤©æ°”:</span> <span class="value-main">${SafeGetValue(worldData, 'å¤©æ°”[0]', 'æœªçŸ¥')}</span></p></div> <div><p><span class="property-name"><i class="fa-solid fa-person-rays icon"></i> å£°æœ›:</span> <span class="value-main">${SafeGetValue(worldData, 'å½“å‰å£°æœ›[0]', 0)}</span></p></div>`); }
        
        function populateProtagonist(data) { 
            const resources = SafeGetValue(data, 'èµ„æº', {}); 
            const equipmentContainer = SafeGetValue(data, 'è£…å¤‡', []); 
            const equipment = Array.isArray(equipmentContainer) && equipmentContainer.length > 0 ? equipmentContainer[0] : {}; 
            const statusEffectsContainer = SafeGetValue(data, 'çŠ¶æ€æ•ˆæœ', []); 
            const statusEffects = Array.isArray(statusEffectsContainer) && statusEffectsContainer.length > 0 ? statusEffectsContainer[0] : {}; 
            const skillsContainer = SafeGetValue(data, 'æŠ€èƒ½', []); 
            const skills = Array.isArray(skillsContainer) && skillsContainer.length > 0 ? skillsContainer[0] : {}; 
            const sexStatsContainer = SafeGetValue(data, 'æ€§çˆ±ç»Ÿè®¡', []);
            const sexStats = Array.isArray(sexStatsContainer) && sexStatsContainer.length > 0 ? sexStatsContainer[0] : {};

            const hp = SafeGetValue(resources, 'ç”Ÿå‘½å€¼[0]', 0); const maxHp = SafeGetValue(resources, 'ç”Ÿå‘½å€¼ä¸Šé™[0]', 1); 
            const mp = SafeGetValue(resources, 'æ³•åŠ›å€¼[0]', 0); const maxMp = SafeGetValue(resources, 'æ³•åŠ›å€¼ä¸Šé™[0]', 1); 
            const sp = SafeGetValue(resources, 'ä½“åŠ›å€¼[0]', 0); const maxSp = SafeGetValue(resources, 'ä½“åŠ›å€¼ä¸Šé™[0]', 1); 
            
            // ã€ä¿®æ­£ 2ã€‘è¿‡æ»¤çŠ¶æ€æ•ˆæœåˆ—è¡¨ä¸­çš„ //reason
            const effectKeys = typeof statusEffects === 'object' && statusEffects !== null ? Object.keys(statusEffects).filter(k => k !== '$meta' && k !== '//reason') : []; 
            // ã€ä¿®æ­£ 3ã€‘è¿‡æ»¤æŠ€èƒ½åˆ—è¡¨ä¸­çš„ //reason
            const skillKeys = typeof skills === 'object' && skills !== null ? Object.keys(skills).filter(k => k !== '$meta' && k !== '//reason') : []; 
            const emptyIcon = `<i class="fa-solid fa-scroll fa-xs" style="opacity: 0.6; margin-right: 5px;"></i>`; 

            const resourcesHtml = `<div class="detail-grid" style="gap: 6px;"> <div class="resource-grid-item" style="border: none; padding-bottom: 0;"> <div class="resource-row"> <span class="icon" style="color:var(--hp-color);"><i class="fa-solid fa-heart"></i></span> <div class="progress-bar-container"><div id="main-hp-bar" class="progress-bar-value"></div></div> <span class="value-main">${hp} / ${maxHp}</span> </div> </div> <div class="resource-grid-item" style="border: none; padding-bottom: 0;"> <div class="resource-row"> <span class="icon" style="color:var(--mp-color);"><i class="fa-solid fa-wand-sparkles"></i></span> <div class="progress-bar-container"><div id="main-mp-bar" class="progress-bar-value"></div></div> <span class="value-main">${mp} / ${maxMp}</span> </div> </div> <div class="resource-grid-item" style="border: none; padding-bottom: 0;"> <div class="resource-row"> <span class="icon" style="color:var(--stamina-color);"><i class="fa-solid fa-person-running"></i></span> <div class="progress-bar-container"><div id="main-sp-bar" class="progress-bar-value"></div></div> <span class="value-main">${sp} / ${maxSp}</span> </div> </div> </div>`; 
            
            const staticHtml = `<hr> <div class="detail-grid"> <div class="detail-grid-item"><span class="icon"><i class="fa-solid fa-id-card"></i></span><span class="property-name">å§“å</span><span class="value-main">${SafeGetValue(data, 'å§“å[0]', 'æœªè®¾å®š')}</span></div> <div class="detail-grid-item"><span class="icon"><i class="fa-solid fa-shield-halved"></i></span><span class="property-name">èº«ä»½</span><span class="value-main">${SafeGetValue(data, 'èº«ä»½[0]', 'æ— ')}</span></div> <div class="detail-grid-item"><span class="icon"><i class="fa-solid fa-khanda"></i></span><span class="property-name">åŠ›é‡å±‚æ¬¡</span><span class="value-main">${SafeGetValue(data, 'åŠ›é‡å±‚æ¬¡[0]', 'å‡¡äºº')}</span></div> </div>`; 
            
            const equipmentHtml = `<div class="detail-grid"> <div class="detail-grid-item"><span class="icon"><i class="fa-solid fa-gavel"></i></span><span class="property-name">æ­¦å™¨</span><span class="value-main">${SafeGetValue(equipment, 'æ­¦å™¨[0]', '(æ— )')}</span></div> <div class="detail-grid-item"><span class="icon"><i class="fa-solid fa-shirt"></i></span><span class="property-name">ç›”ç”²</span><span class="value-main">${SafeGetValue(equipment, 'ç›”ç”²[0]', '(æ— )')}</span></div> <div class="detail-grid-item"><span class="icon"><i class="fa-solid fa-ring"></i></span><span class="property-name">é¥°å“</span><span class="value-main">${SafeGetValue(equipment, 'é¥°å“[0]', '(æ— )')}</span></div> <div class="detail-grid-item"><span class="icon"><i class="fa-solid fa-socks"></i></span><span class="property-name">å†…è¡£</span><span class="value-main">${SafeGetValue(equipment, 'å†…è¡£[0]', '(æ— )')}</span></div> <div class="detail-grid-item"><span class="icon"><i class="fa-solid fa-link"></i></span><span class="property-name">ç‰¹æ®Š</span><span class="value-main">${SafeGetValue(equipment, 'ç‰¹æ®Š[0]', '(æ— )')}</span></div> </div>`; 
            
            const effectsHtml = `<div id="status-effects-list" style="padding: 5px 0;"> ${effectKeys.length > 0 ? effectKeys.map(key => { const effect = statusEffects[key]; return `<div class="item-row"> <div><b>${SafeGetValue(effect, 'åç§°[0]', key)}</b><br><small>${SafeGetValue(effect, 'æè¿°[0]', '...')}</small></div> <span class="value-main">${SafeGetValue(effect, 'å‰©ä½™æ—¶é—´[0]', '')}</span> </div>`; }).join('') : `<p class="empty-state-text">${emptyIcon}(æ— )</p>`} </div>`; 
            
            const skillsHtml = `<div id="skills-list" style="padding: 5px 0;"> ${skillKeys.length > 0 ? skillKeys.map(key => { const skill = skills[key]; const cost = SafeGetValue(skill, 'cost[0]', ''); const tagsArray = SafeGetValue(skill, 'tags[0]', []); const tags = Array.isArray(tagsArray) ? tagsArray.map(tag => `<span class="tag">${tag}</span>`).join(' ') : ''; return `<div class="item-row"> <div><b>${SafeGetValue(skill, 'åç§°[0]', key)}</b> (Lv.${SafeGetValue(skill, 'ç­‰çº§[0]', 1)}) ${tags}<br><small>${SafeGetValue(skill, 'æè¿°[0]', '...')}</small></div> <span class="value-main">${cost}</span> </div>`; }).join('') : `<p class="empty-state-text">${emptyIcon}(æ— æŠ€èƒ½)</p>`} </div>`; 
            
            const isVirgin = SafeGetValue(sexStats, 'æ˜¯å¦å¤„ç”·[0]', SafeGetValue(sexStats, 'æ˜¯å¦å¤„å¥³[0]', true));
            const fetishesArray = SafeGetValue(sexStats, 'æ€§ç™–', []);
            const fetishes = (Array.isArray(fetishesArray) ? fetishesArray[0] : []) || [];
            const privacyHtml = `
            <div class="detail-grid">
                <div class="detail-grid-item">
                    <span class="icon" style="color: var(--accent-pink)"><i class="fa-solid ${isVirgin ? 'fa-lock' : 'fa-lock-open'}"></i></span>
                    <span class="property-name">è´æ´</span>
                    <span class="value-main">${isVirgin ? 'ä¿ç•™' : 'å·²å¤±'}</span>
                </div>
                <div class="detail-grid-item">
                    <span class="icon" style="color: var(--accent-pink)"><i class="fa-solid fa-calculator"></i></span>
                    <span class="property-name">äº¤åˆæ¬¡æ•°</span>
                    <span class="value-main">${SafeGetValue(sexStats, 'äº¤åˆæ¬¡æ•°[0]', 0)}</span>
                </div>
            </div>
            <hr>
            <p><span class="property-name"><i class="fa-solid fa-mask icon"></i> æ€§ç™–è§‰é†’:</span></p>
            <div style="margin-top:5px;">${Array.isArray(fetishes) && fetishes.length > 0 ? fetishes.map(f => `<span class="erotic-tag">${f}</span>`).join('') : '<span style="font-size:0.9em; opacity:0.7;">(æš‚æ— ç‰¹æ®Šæ€§ç™–)</span>'}</div>
            `;

            const tabsHtml = `
            <div class="protagonist-tabs"> 
                <div class="protagonist-tab ${currentProtagonistTab === 'core' ? 'active' : ''}" data-tab="core">æ ¸å¿ƒ</div> 
                <div class="protagonist-tab ${currentProtagonistTab === 'equip' ? 'active' : ''}" data-tab="equip">è£…å¤‡</div> 
                <div class="protagonist-tab ${currentProtagonistTab === 'skills' ? 'active' : ''}" data-tab="skills">æŠ€èƒ½</div> 
                <div class="protagonist-tab ${currentProtagonistTab === 'effects' ? 'active' : ''}" data-tab="effects">çŠ¶æ€</div>
                <div class="protagonist-tab ${currentProtagonistTab === 'privacy' ? 'active' : ''}" data-tab="privacy" style="color: var(--accent-pink);">éšç§</div> 
            </div> 
            <div class="protagonist-tab-content ${currentProtagonistTab !== 'core' ? 'hidden' : ''}" id="protagonist-core"> ${resourcesHtml} ${staticHtml} </div> 
            <div class="protagonist-tab-content ${currentProtagonistTab !== 'equip' ? 'hidden' : ''}" id="protagonist-equip"> ${equipmentHtml} </div> 
            <div class="protagonist-tab-content ${currentProtagonistTab !== 'skills' ? 'hidden' : ''}" id="protagonist-skills"> ${skillsHtml} </div> 
            <div class="protagonist-tab-content ${currentProtagonistTab !== 'effects' ? 'hidden' : ''}" id="protagonist-effects"> ${effectsHtml} </div>
            <div class="protagonist-tab-content ${currentProtagonistTab !== 'privacy' ? 'hidden' : ''}" id="protagonist-privacy"> ${privacyHtml} </div>`; 
            
            setContent('protagonist-section', tabsHtml); 
            royal_updateProgressBar('main-hp-bar', hp, maxHp); royal_updateProgressBar('main-mp-bar', mp, maxMp); royal_updateProgressBar('main-sp-bar', sp, maxSp); 
        }

        function populateMap(worldData) { const locationsArray = SafeGetValue(worldData, 'é‚»è¿‘åœ°ç‚¹[0]', []) || []; const validLocations = Array.isArray(locationsArray) ? locationsArray.filter(loc => Array.isArray(loc) && loc.length > 0 && typeof loc[0] === 'string' && loc[0].trim() !== '' && loc[0] !== 'æœªçŸ¥åœ°ç‚¹') : []; const emptyIcon = `<i class="fa-solid fa-map-signs fa-xs" style="opacity: 0.6; margin-right: 5px;"></i>`; const content = validLocations.map(loc => { const locName = loc[0]; const locDesc = loc.length > 1 && typeof loc[1] === 'string' ? loc[1] : ''; return `<div class="map-location"> <div class="location-text"><b>${locName}</b><br><small>${locDesc}</small></div> <button class="action-button" data-action="travel" data-location="${locName}" style="margin-left: auto; padding: 3px 6px; font-size: 0.8em;"> <i class="fa-solid fa-shoe-prints"></i>å‰å¾€ </button> </div>`; }).join(''); setContent('map-section', content || `<p class="empty-state-text">${emptyIcon}é™„è¿‘ä¼¼ä¹æ²¡ä»€ä¹ˆå¯æ¢ç´¢çš„ã€‚</p>`); }
        
        function populateDestinyAndContacts(data) { 
            const contactsContainer = SafeGetValue(data, 'äººè„‰å…³ç³»', []); 
            const contacts = Array.isArray(contactsContainer) && contactsContainer.length > 0 ? contactsContainer[0] : {}; 
            // ã€ä¿®æ­£ 4ã€‘è¿‡æ»¤äººè„‰åˆ—è¡¨ä¸­çš„ //reason
            const contactKeys = typeof contacts === 'object' && contacts !== null ? Object.keys(contacts).filter(k => k !== '$meta' && k !== '//reason') : []; 
            const destinyData = SafeGetValue(data, 'å‘½è¿ç³»ç»Ÿ', {}); 
            const redlineCharsContainer = SafeGetValue(destinyData, 'çº¢çº¿å¯¹è±¡', []); 
            const redlineChars = Array.isArray(redlineCharsContainer) && redlineCharsContainer.length > 0 ? redlineCharsContainer[0] : {}; 
            // ã€ä¿®æ­£ 5ã€‘è¿‡æ»¤çº¢çº¿å¯¹è±¡åˆ—è¡¨ä¸­çš„ //reason
            const redlineKeys = typeof redlineChars === 'object' && redlineChars !== null ? Object.keys(redlineChars).filter(k => k !== '$meta' && k !== '//reason') : []; 
            const emptyIcon = `<i class="fa-solid fa-scroll fa-xs" style="opacity: 0.6; margin-right: 5px;"></i>`; 
            
            let contactsHtml = contactKeys.length > 0 ? contactKeys.map(k => createCharacterCardHTML(contacts[k], k, false)).join('') : `<p class="empty-state-text">${emptyIcon}(æ— äººè„‰)</p>`; 
            let destinyHtml = `<div class="detail-grid-item" style="grid-template-columns: 20px auto 1fr; align-items: center; border: none; padding-bottom: 5px;"><span class="icon"><i class="fa-solid fa-hand-holding-heart"></i></span><span class="property-name">å‘½è¿ç‚¹æ•° FP</span> <span class="value-main fp-value">${SafeGetValue(destinyData, 'å‘½è¿ç‚¹æ•°[0]', 0)}</span></div><hr>` + (redlineKeys.length > 0 ? redlineKeys.map(k => createCharacterCardHTML(redlineChars[k], k, true)).join('') : `<p class="empty-state-text">${emptyIcon}(æ— çº¢çº¿å¯¹è±¡)</p>`); 
            setContent('contacts-section', contactsHtml); setContent('destiny-section', destinyHtml); [...contactKeys, ...redlineKeys].forEach(key => { const char = contacts[key] || redlineChars[key]; if (typeof char === 'object' && char !== null) { const barId = `char-favor-bar-${key}`; const fav = SafeGetValue(char, 'å¥½æ„Ÿåº¦[0]', '0/1000'); const [cur, max] = String(fav).split(' ')[0].split('/').map(Number); royal_updateProgressBar(barId, cur || 0, max || 1000); } }); 
        }
        
        // NPCå¡ç‰‡æ¸²æŸ“ (åŒ…å«å²æœˆå˜åŒ–ä¸æ€§å¾æè¿°)
        function createCharacterCardHTML(npcData, npcKey, isRedLine) { 
            const name = SafeGetValue(npcData, 'å§“å[0]', 'æœªçŸ¥è§’è‰²'); 
            const affectionText = String(SafeGetValue(npcData, 'å¥½æ„Ÿåº¦[0]', '0/1000')).split(' ')[0]; 
            const barId = `char-favor-bar-${npcKey}`; 
            
            const properties = [ 
                { name: 'æˆ˜åŠ›å±‚çº§', value: SafeGetValue(npcData, 'æˆ˜åŠ›å±‚çº§[0]'), icon: 'fa-solid fa-bolt' }, 
                { name: 'ç­‰çº§', value: SafeGetValue(npcData, 'ç­‰çº§[0]'), icon: 'fa-solid fa-dragon' }, 
                { name: 'å¹´é¾„', value: SafeGetValue(npcData, 'å¹´é¾„[0]'), icon: 'fa-solid fa-hourglass-half' }, 
                { name: 'ç§æ—', value: SafeGetValue(npcData, 'ç§æ—[0]'), icon: 'fa-solid fa-paw' }, 
                { name: 'èº«ä»½', value: SafeGetValue(npcData, 'èº«ä»½[0]'), icon: 'fa-solid fa-shield-halved' }, 
                { name: 'èŒä¸š', value: SafeGetValue(npcData, 'èŒä¸š[0]'), icon: 'fa-solid fa-briefcase' }, 
                { name: 'è¡£ç€', value: SafeGetValue(npcData, 'è¡£ç€[0]'), icon: 'fa-solid fa-shirt' },
                { name: 'è£…å¤‡', value: SafeGetValue(npcData, 'è£…å¤‡[0]'), icon: 'fa-solid fa-khanda' },
                { name: 'æ€§æ ¼', value: SafeGetValue(npcData, 'æ€§æ ¼[0]'), icon: 'fa-solid fa-brain' }, 
                { name: 'å–œçˆ±', value: SafeGetValue(npcData, 'å–œçˆ±[0]'), icon: 'fa-solid fa-star' }, 
                { name: 'å¤–è²Œ', value: SafeGetValue(npcData, 'å¤–è²Œ[0]'), icon: 'fa-solid fa-image-portrait' }
            ]; 
            
            const innerThoughts = SafeGetValue(npcData, 'å†…å¿ƒæƒ³æ³•[0]');
            let thoughtsHtml = '';
            if (innerThoughts && innerThoughts !== 'æœªçŸ¥' && innerThoughts !== '') {
                thoughtsHtml = `<div class="inner-thought-block"><i class="fa-solid fa-comment-dots" style="opacity:0.7; margin-right:5px;"></i> ${innerThoughts}</div>`;
            }

            const bodyProps = [
                { key: 'å¥¶å­', icon: 'fa-solid fa-circle-dot', name: 'å¥¶å­' },
                { key: 'å°ç©´', icon: 'fa-solid fa-spa', name: 'å°ç©´' },
                { key: 'å±çœ¼', icon: 'fa-solid fa-bullseye', name: 'å±çœ¼' },
                { key: 'ç‰è¶³', icon: 'fa-solid fa-shoe-prints', name: 'ç‰è¶³' }
            ];
            let bodyHtml = '';
            bodyProps.forEach(prop => {
                const val = SafeGetValue(npcData, `${prop.key}[0]`);
                if (val && val !== 'æœªçŸ¥' && val !== '') {
                    bodyHtml += `<div style="margin-bottom:6px;"><span class="property-name" style="color:var(--accent-pink); font-size:0.75em;"><i class="${prop.icon}"></i> ${prop.name}</span><div class="long-text-block">${val}</div></div>`;
                }
            });

            let eroticStatsHtml = '';
            const isVirgin = SafeGetValue(npcData, 'æ˜¯å¦å¤„å¥³[0]');
            const sexCount = SafeGetValue(npcData, 'äº¤åˆæ¬¡æ•°[0]');
            const sexExp = SafeGetValue(npcData, 'æ€§çˆ±ç»éªŒ[0]');
            const fetishRaw = SafeGetValue(npcData, 'æ€§ç™–', []); 
            let fetishArr = [];
            if (Array.isArray(fetishRaw)) {
                 if (fetishRaw.length > 0 && Array.isArray(fetishRaw[0])) fetishArr = fetishRaw[0]; 
                 else if (fetishRaw.length > 0 && typeof fetishRaw[0] === 'string') fetishArr = fetishRaw; 
            }

            if (isVirgin !== undefined || sexCount !== undefined || (fetishArr.length > 0)) {
                eroticStatsHtml = `<hr style="border-color:var(--accent-pink); opacity:0.3;">`;
                if (isVirgin !== undefined) eroticStatsHtml += `<span class="tag" style="background:${isVirgin?'#4CAF50':'#D81B60'}">${isVirgin ? 'å¤„å¥³' : 'éå¤„'}</span> `;
                if (sexCount !== undefined) eroticStatsHtml += `<span class="tag" style="background:#6D4C41">æ¬¡æ•°: ${sexCount}</span> `;
                if (sexExp) eroticStatsHtml += `<div class="long-text-block" style="font-style:italic; margin-top:5px;">${sexExp}</div>`;
                if (fetishArr.length > 0) {
                    eroticStatsHtml += `<div style="margin-top:5px;"><span class="property-name" style="font-size:0.7em;">æ€§ç™–: </span>${fetishArr.map(f => `<span class="erotic-tag">${f}</span>`).join('')}</div>`;
                }
            }

            let memoryHtml = '';
            if (isRedLine) {
                const memories = SafeGetValue(npcData, 'è®°å¿†å›å»Š', {});
                // ã€ä¿®æ­£ 6ã€‘è¿‡æ»¤è®°å¿†å›å»Šä¸­çš„ //reason
                const memoryKeys = Object.keys(memories).filter(k => k !== '$meta' && k !== '//reason');
                if (memoryKeys.length > 0) {
                    memoryHtml = `<hr><h4 style="font-size:0.9em; margin-bottom:5px; color:var(--accent-purple);"><i class="fa-solid fa-brain"></i> è®°å¿†å›å»Š</h4>`;
                    memoryKeys.forEach(memKey => {
                        const mem = memories[memKey];
                        const mTitle = SafeGetValue(mem, 'æ ‡é¢˜[0]', 'æœªçŸ¥è®°å¿†');
                        const mDesc = SafeGetValue(mem, 'æè¿°[0]', '...');
                        memoryHtml += `<details class="sub-section memory-entry" style="margin-bottom:4px; border-color:rgba(142,36,170,0.3);">
                            <summary style="font-size:0.85em; padding:4px 8px;">${mTitle}</summary>
                            <div class="sub-section-content" style="font-size:0.85em; color:#555;">${mDesc}</div>
                        </details>`;
                    });
                }
            }

            return `
            <details class="sub-section ${isRedLine ? 'is-redline' : ''}"> 
                <summary>${name}<span class="arrow-toggle">&gt;</span></summary> 
                <div class="sub-section-content"> 
                    <div class="detail-grid"> 
                        ${properties.map(p => `<div class="detail-grid-item"><span class="icon"><i class="${p.icon}"></i></span><span class="property-name">${p.name}</span><span class="value-main">${p.value || 'æœªçŸ¥'}</span></div>`).join('')} 
                    </div> 
                    ${thoughtsHtml}
                    ${bodyHtml ? `<hr style="border-color:var(--accent-pink); opacity:0.3;"> <div style="color:var(--text-color);">${bodyHtml}</div>` : ''}
                    ${eroticStatsHtml}
                    ${memoryHtml}
                    <hr> 
                    <p style="text-align:center; margin-bottom: 3px;"><span class="property-name">å¥½æ„Ÿåº¦: ${affectionText}</span></p> 
                    <div class="char-favor-bar-container"><div id="${barId}" class="char-favor-bar"></div></div> 
                    <hr> 
                    <p style="margin-bottom: 3px;"><span class="property-name">è¯„ä»·:</span><br><span style="font-style: italic; font-size: 0.9em; opacity: 0.9;">${SafeGetValue(npcData, 'è¯„ä»·[0]', 'æš‚æ— ')}</span></p> 
                </div> 
            </details>`; 
        }

        // ã€ä¿®æ­£ 7ã€‘ä»»åŠ¡ç³»ç»Ÿï¼šå¢åŠ äº†å¯¹ null ä»»åŠ¡çš„è¿‡æ»¤ï¼ˆè½¯åˆ é™¤æ”¯æŒï¼‰
        function populateQuests(tasks) { 
            // å¼ºå£®æ€§æ£€æŸ¥
            if (!tasks || typeof tasks !== 'object') {
                 setContent('tasks-section', `<p class="empty-state-text"><i class="fa-solid fa-triangle-exclamation"></i> ä»»åŠ¡æ•°æ®å¼‚å¸¸</p>`);
                 return;
            }
            
            const taskKeys = Object.keys(tasks).filter(k => k !== '$meta' && k !== '//reason'); 
            const emptyIcon = `<i class="fa-solid fa-scroll fa-xs" style="opacity: 0.6; margin-right: 5px;"></i>`; 
            
            const content = taskKeys.length > 0 ? taskKeys.map(k => { 
                const task = tasks[k]; 
                // [å…³é”®] å¦‚æœä»»åŠ¡ä¸º null (å·²è¢«è½¯åˆ é™¤)ï¼Œåˆ™ä¸æ¸²æŸ“
                if (!task || typeof task !== 'object') return ''; 
                
                const rewardObjContainer = SafeGetValue(task, 'å¥–åŠ±', []); 
                const rewardObj = Array.isArray(rewardObjContainer) && rewardObjContainer.length > 0 ? rewardObjContainer[0] : {}; 
                let rewardParts = []; 
                if (typeof rewardObj === 'object' && rewardObj !== null) { 
                    const currency = SafeGetValue(rewardObj, 'è´§å¸', {}); 
                    if (typeof currency === 'object' && currency !== null) { 
                        Object.keys(currency).forEach(cKey => { 
                            const amount = SafeGetValue(currency, `${cKey}[0]`, 0); 
                            if (amount > 0) { rewardParts.push(`${cKey} x${amount}`); } 
                        }); 
                    } 
                    const items = SafeGetValue(rewardObj, 'ç‰©å“', {}); 
                    if (typeof items === 'object' && items !== null) { 
                        Object.keys(items).forEach(iKey => { 
                            const amount = SafeGetValue(items, `${iKey}[0]`, 0); 
                            if (amount > 0) { rewardParts.push(`${iKey} x${amount}`); } 
                        }); 
                    } 
                    const exp = SafeGetValue(rewardObj, 'ç»éªŒ[0]', 0); if (exp > 0) { rewardParts.push(`ç»éªŒ x${exp}`); } 
                    const fp = SafeGetValue(rewardObj, 'FP[0]', 0); if (fp > 0) { rewardParts.push(`FP x${fp}`); } 
                } 
                const rewardString = rewardParts.length > 0 ? rewardParts.join(', ') : 'æ— '; 
                return `<details class="sub-section"> <summary>${SafeGetValue(task, 'æ ‡é¢˜[0]', `ä»»åŠ¡ ${k}`)}<span class="arrow-toggle">&gt;</span></summary> <div class="sub-section-content"> <p><b>å‘å¸ƒè€…:</b> ${SafeGetValue(task, 'å‘å¸ƒè€…[0]', 'æœªçŸ¥')}</p> <p><b>ç›®æ ‡:</b> ${SafeGetValue(task, 'å½“å‰ç›®æ ‡[0]', '...')}</p> <p><b>éš¾åº¦:</b> ${SafeGetValue(task, 'éš¾åº¦[0]', '?')} â­</p> <p><b>å¥–åŠ±:</b> ${rewardString}</p> <p><b>å¤±è´¥æƒ©ç½š:</b> ${SafeGetValue(task, 'å¤±è´¥æƒ©ç½š[0]', 'æ— ')}</p> </div> </details>`; 
            }).join('') : `<p class="empty-state-text">${emptyIcon}(æš‚æ— ä»»åŠ¡)</p>`; 
            setContent('tasks-section', content); 
        }
        
function populateAssets(assetsData) { 
    const currency = SafeGetValue(assetsData, 'è´§å¸', {}); 
    const inventoryContainer = SafeGetValue(assetsData, 'èƒŒåŒ…', []); 
    const inventory = Array.isArray(inventoryContainer) && inventoryContainer.length > 0 ? inventoryContainer[0] : {}; 
    
    // è¿‡æ»¤èƒŒåŒ…åˆ—è¡¨ä¸­çš„ //reason
    const invKeys = typeof inventory === 'object' && inventory !== null ? Object.keys(inventory).filter(k => k !== '$meta' && k !== '//reason') : []; 
    const currencyIcons = { 'é‡‘å¸': 'fa-solid fa-circle-dollar-to-slot icon-gold', 'é“¶å¸': 'fa-solid fa-coins icon-silver', 'é“œå¸': 'fa-solid fa-circle icon-copper', 'ç™½é‡‘å¸': 'fa-solid fa-gem icon-platinum', 'æ˜Ÿè¾‰ç»“æ™¶': 'fa-solid fa-star icon-crystal', 'å…½éª¨å¸': 'fa-solid fa-bone icon-bone' }; 
    const emptyIcon = `<i class="fa-solid fa-scroll fa-xs" style="opacity: 0.6; margin-right: 5px;"></i>`; 
    
    // æ¸²æŸ“è´§å¸
    const currencyHtml = typeof currency === 'object' && currency !== null && Object.keys(currency).length > 0 ? `<div class="currency-grid">${Object.keys(currency).filter(c => c !== '$meta' && c !== '//reason').map(c => `<div class="currency-item"><i class="currency-icon ${currencyIcons[c] || 'fa-solid fa-sack-dollar'}"></i><div class="currency-info"><span class="property-name">${c}</span><div class="value-main">${SafeGetValue(currency, `${c}[0]`, 0)}</div></div></div>`).join('')}</div>` : `<p class="empty-state-text">${emptyIcon}(æ²¡æœ‰è´§å¸)</p>`; 
    
    const filteredInvKeys = invKeys.filter(key => { const item = inventory[key]; if (currentInventoryFilter === 'å…¨éƒ¨') return true; const itemType = SafeGetValue(item, 'type[0]', 'æœªçŸ¥'); return itemType === currentInventoryFilter; }); 
    
    // --- [ æ ¸å¿ƒä¿®å¤ï¼šæ·»åŠ  event.preventDefault() é˜²æ­¢å†²çª ] ---
    const inventoryHtml = filteredInvKeys.length > 0 ? filteredInvKeys.map(key => { 
        const item = inventory[key]; 
        if (typeof item !== 'object' || item === null) return ''; 
        
        const desc = SafeGetValue(item, 'æè¿°[0]', 'æš‚æ— è¯¦ç»†ä»‹ç»ã€‚');
        const name = SafeGetValue(item, 'åç§°[0]', key);
        const count = SafeGetValue(item, 'æ•°é‡[0]', 1);
        const type = SafeGetValue(item, 'type[0]', '?');
        const isUsable = SafeGetValue(item, 'usable[0]', false);

        // æ³¨æ„ä¸‹é¢çš„ button onclick äº‹ä»¶
        return `
        <details style="border-bottom: 1px dotted var(--border-color); margin-bottom: 0;"> 
            <summary style="display: flex; align-items: center; justify-content: space-between; padding: 8px 5px; cursor: pointer; list-style: none;">
                <div> 
                    <b>${name}</b> (x${count}) <span class="tag">${type}</span> 
                </div> 
                ${isUsable ? `
                    <button class="action-button" 
                            data-action="use-item" 
                            data-item-name="${name}" 
                            onclick="event.preventDefault();" 
                            style="padding: 2px 6px; font-size: 0.8em; margin-left: 8px; position: relative; z-index: 10;">
                        <i class="fa-solid fa-hand-pointer"></i>ä½¿ç”¨
                    </button>` 
                : ''} 
            </summary>
            <div style="padding: 5px 10px 10px 10px; font-size: 0.9em; color: var(--secondary-text); background: rgba(0,0,0,0.03); border-radius: 4px; margin: 0 5px 5px 5px;">
                <i class="fa-solid fa-circle-info" style="opacity:0.7; font-size:0.9em; margin-right:4px;"></i> ${desc}
            </div>
        </details>`; 
    }).join('') : `<p class="empty-state-text">${emptyIcon}(æ— ${currentInventoryFilter !== 'å…¨éƒ¨' ? currentInventoryFilter : ''}ç‰©å“)</p>`; 
    
    const itemTypes = ['å…¨éƒ¨', ...new Set(invKeys.map(key => SafeGetValue(inventory[key], 'type[0]', null)).filter(Boolean))]; 
    const filterButtonsHtml = `<div style="margin-bottom: 8px; display: flex; flex-wrap: wrap; gap: 4px;">${itemTypes.map(type => `<button class="filter-btn ${currentInventoryFilter === type ? 'active' : ''}" data-filter-type="inventory" data-filter-value="${type}">${type}</button>`).join('')}</div>`; 
    
    setContent('assets-section', `${currencyHtml}<hr><h4>èƒŒåŒ…</h4>${filterButtonsHtml}${inventoryHtml}`); 
}
        
        function populateNews(news) { const formatNews = (newsText) => (newsText || '(æš‚æ— )').replace(/\\n/g, '<br>'); setContent('news-section', ` <button class="action-button" data-action="update-news" style="width:100%; margin-bottom: 10px;"><i class="fa-solid fa-rotate"></i>æ›´æ–°æƒ…æŠ¥</button> <details class="sub-section"><summary>é‡‘ç‹®å¿«è®¯</summary><div class="sub-section-content">${formatNews(SafeGetValue(news, 'é‡‘ç‹®å¿«è®¯[0]', '(æš‚æ— )'))}</div></details> <details class="sub-section"><summary>é…’é¦†ç•™è¨€æ¿</summary><div class="sub-section-content">${formatNews(SafeGetValue(news, 'é…’é¦†ç•™è¨€æ¿[0]', '(æš‚æ— )'))}</div></details> <details class="sub-section"><summary>ä¸–ç•ŒçœŸå¥‡å¦™</summary><div class="sub-section-content">${formatNews(SafeGetValue(news, 'ä¸–ç•ŒçœŸå¥‡å¦™[0]', '(æš‚æ— )'))}</div></details> <details class="sub-section"><summary>è‰è‰ä¸çš„åˆåèŒ¶ä¼š</summary><div class="sub-section-content">${formatNews(SafeGetValue(news, 'è‰è‰ä¸çš„åˆåèŒ¶ä¼š[0]', '(æš‚æ— )'))}</div></details> `); }
        
        function populateCodex(codexContainer) { 
            const codex = Array.isArray(codexContainer) && codexContainer.length > 0 ? codexContainer[0] : {}; 
            // ã€ä¿®æ­£ 10ã€‘è¿‡æ»¤å›¾é‰´ä¸­çš„ //reason
            const codexKeys = typeof codex === 'object' && codex !== null ? Object.keys(codex).filter(k => k !== '$meta' && k !== '//reason') : []; 
            const emptyIcon = `<i class="fa-solid fa-scroll fa-xs" style="opacity: 0.6; margin-right: 5px;"></i>`; 
            const content = codexKeys.length > 0 ? codexKeys.map(k => { const entry = codex[k]; if (typeof entry !== 'object' || entry === null) return ''; const category = SafeGetValue(entry, 'åˆ†ç±»[0]', 'æœªçŸ¥'); const title = SafeGetValue(entry, 'æ ‡é¢˜[0]', 'æœªçŸ¥æ¡ç›®'); const description = SafeGetValue(entry, 'æè¿°[0]', '...'); let icon = 'fa-solid fa-question'; if (category === 'åœ°ç‚¹') icon = 'fa-solid fa-map'; else if (category === 'äººç‰©') icon = 'fa-solid fa-user-pen'; else if (category === 'å†å²') icon = 'fa-solid fa-landmark'; else if (category === 'ç‰©å“') icon = 'fa-solid fa-gem'; return `<details class="sub-section memory-entry"> <summary><i class="${icon} icon" style="margin-right: 8px; font-size: 0.9em; opacity: 0.7;"></i> [${category}] ${title}<span class="arrow-toggle">&gt;</span></summary> <div class="sub-section-content memory-content"> <p>${description.replace(/\\n/g, '<br>')}</p> </div> </details>`; }).join('') : `<p class="empty-state-text">${emptyIcon}(å›¾é‰´ä¸ºç©º)</p>`; setContent('codex-section', content); 
        }


        // --- [ 4. æˆ˜æ–— UI æ¸²æŸ“å™¨ ] ---
        
        window.battle_ui_events = {
            selectTab: (tabName) => {
                currentCombatTab = tabName; 
                renderBattleUI(window.last_stat_data); 
            },
            _addToPreInput: (text) => {
                try {
                    const preInputEl = document.getElementById('pre-input-bar');
                    if (!preInputEl) return;
                    const oldText_DOM = preInputEl.value;
                    const oldText_MVU = SafeGetValue(window.last_stat_data, 'æˆ˜æ–—çŠ¶æ€.é¢„è¾“å…¥[0]', ''); 
                    const newText_DOM = oldText_DOM ? oldText_DOM + '\n' + text : text;
                    const newText_MVU = oldText_MVU ? oldText_MVU + '\\n' + text : text; 
                    preInputEl.value = newText_DOM;
                    if (window.last_stat_data && window.last_stat_data['æˆ˜æ–—çŠ¶æ€'] && window.last_stat_data['æˆ˜æ–—çŠ¶æ€']['é¢„è¾“å…¥']) {
                        window.last_stat_data['æˆ˜æ–—çŠ¶æ€']['é¢„è¾“å…¥'][0] = newText_MVU;
                    }
                    window.SillyTavern_MVU_Set('æˆ˜æ–—çŠ¶æ€.é¢„è¾“å…¥[0]', oldText_MVU, newText_MVU, 'UI: æ·»åŠ è¡ŒåŠ¨');
                } catch(e) { console.error("[MasterUI] _addToPreInput failed:", e); }
            },
            _getCurrentTargetName: () => {
                return SafeGetValue(window.last_stat_data, `æˆ˜æ–—çŠ¶æ€[0].allies.${selectedParticipantKey}.åç§°[0]`, 
                       SafeGetValue(window.last_stat_data, `æˆ˜æ–—çŠ¶æ€[0].enemies.${selectedParticipantKey}.åç§°[0]`, '??'));
            },
            useSkill: (skillName, skillKey) => { window.battle_ui_events._addToPreInput(`${window.battle_ui_events._getCurrentTargetName()} [ä½¿ç”¨æŠ€èƒ½] ${skillName}`); },
            useItem: (itemName, itemKey) => { window.battle_ui_events._addToPreInput(`${window.battle_ui_events._getCurrentTargetName()} [ä½¿ç”¨ç‰©å“] ${itemName}`); },
            coreAction: (action) => { window.battle_ui_events._addToPreInput(`${window.battle_ui_events._getCurrentTargetName()} [${action}]`); },
            startTurn: () => {
                try {
                    const preInputEl = document.getElementById('pre-input-bar');
                    if (!preInputEl) return;
                    const textToSend = preInputEl.value; 
                    const oldText_MVU = SafeGetValue(window.last_stat_data, 'æˆ˜æ–—çŠ¶æ€.é¢„è¾“å…¥[0]', ''); 
                    if (textToSend && textToSend.trim() !== '') {
                        const formattedCommand = `/send ${textToSend.replace(/\n/g, ' ')} |/trigger`;
                        window.SillyTavern_TriggerSlash(formattedCommand); 
                        preInputEl.value = '';
                        if (window.last_stat_data && window.last_stat_data['æˆ˜æ–—çŠ¶æ€'] && window.last_stat_data['æˆ˜æ–—çŠ¶æ€']['é¢„è¾“å…¥']) {
                            window.last_stat_data['æˆ˜æ–—çŠ¶æ€']['é¢„è¾“å…¥'][0] = '';
                        }
                        window.SillyTavern_MVU_Set('æˆ˜æ–—çŠ¶æ€.é¢„è¾“å…¥[0]', oldText_MVU, '', 'UI: æ¸…ç©ºé¢„è¾“å…¥å¹¶å·²å‘é€');
                    } else { console.warn("[MasterUI-Battle] é¢„è¾“å…¥ä¸ºç©ºï¼Œä¸å‘é€ã€‚"); }
                } catch(e) { console.error("[MasterUI] startTurn failed:", e); }
            },
            endBattle: () => { window.SillyTavern_TriggerSlash('/send [ç³»ç»ŸæŒ‡ä»¤ï¼šæˆ˜æ–—ç»“æŸï¼Œè¯·æ±‚ç»“ç®—] |/trigger'); }
        };

        function getParticipantData_v15(key, fullData) {
            let skills = {};
            let items = {};

            if (key === 'ä¸»è§’') { 
                skills = SafeGetValue(fullData, 'ä¸»è§’.æŠ€èƒ½[0]', {});
                items = SafeGetValue(fullData, 'è´¢äº§.èƒŒåŒ…[0]', {});
            } else {
                skills = SafeGetValue(fullData, `äººè„‰å…³ç³»[0].${key}.æŠ€èƒ½[0]`, {});
                if (Object.keys(skills).length <= 1) { 
                    skills = SafeGetValue(fullData, `å‘½è¿ç³»ç»Ÿ.çº¢çº¿å¯¹è±¡[0].${key}.æŠ€èƒ½[0]`, {}); 
                }
                items = SafeGetValue(fullData, `äººè„‰å…³ç³»[0].${key}.èƒŒåŒ…[0]`, {});
                 if (Object.keys(items).length <= 1) {
                    items = SafeGetValue(fullData, `å‘½è¿ç³»ç»Ÿ.çº¢çº¿å¯¹è±¡[0].${key}.èƒŒåŒ…[0]`, {});
                }
            }
            return { skills, items };
        }

        function renderBattleUI(data) {
            const wrapper = document.getElementById('battle-ui-wrapper');
            if (!wrapper) { console.error("[MasterUI] Battle UI wrapper not found!"); return; }
            const playerArea = document.getElementById('player-combatants-area');
            const enemyArea = document.getElementById('enemy-combatants-area');
            const playerPlaceholder = document.getElementById('player-combatants-placeholder');
            const enemyPlaceholder = document.getElementById('enemy-combatants-placeholder');
            
            playerArea.innerHTML = '<div class="team-title">å…‰ã®ç›Ÿå‹</div>';
            enemyArea.innerHTML = '<div class="team-title">æ·±æ·µã®æ•µ</div>';

            const alliesObj = SafeGetValue(data, 'æˆ˜æ–—çŠ¶æ€[0].allies', {});
            const enemiesObj = SafeGetValue(data, 'æˆ˜æ–—çŠ¶æ€[0].enemies', {});
            
            // ã€ä¿®æ­£ 11ã€‘è¿‡æ»¤æˆ˜æ–—å•ä½åˆ—è¡¨ä¸­çš„ //reason
            const allyKeys = Object.keys(alliesObj).filter(k => k !== '$meta' && k !== '//reason');
            const enemyKeys = Object.keys(enemiesObj).filter(k => k !== '$meta' && k !== '//reason');

            if (!alliesObj[selectedParticipantKey] && !enemiesObj[selectedParticipantKey]) {
                selectedParticipantKey = allyKeys.length > 0 ? allyKeys[0] : (enemyKeys.length > 0 ? enemyKeys[0] : null);
            }

            let playerUnitsFound = 0;
            allyKeys.forEach(key => {
                const unit = alliesObj[key];
                if (typeof unit !== 'object' || unit === null) return;
                const name = SafeGetValue(unit, 'åç§°[0]', key);
                const type = (key === 'ä¸»è§’' ? 'ä¸»è§’' : 'å‹å†›');
                const hp_val = SafeGetValue(unit, 'ç”Ÿå‘½å€¼[0]', 0); 
                const hp_max = SafeGetValue(unit, 'ç”Ÿå‘½å€¼ä¸Šé™[0]', 100);
                const mp_val = SafeGetValue(unit, 'æ³•åŠ›å€¼[0]', 0);
                const mp_max = SafeGetValue(unit, 'æ³•åŠ›å€¼ä¸Šé™[0]', 100);
                const hp_perc = hp_max > 0 ? (hp_val / hp_max) * 100 : 0;
                const mp_perc = mp_max > 0 ? (mp_val / mp_max) * 100 : 0;
                const isSelected = (key === selectedParticipantKey); 

                let barHtml = `<div class="combatant-bar ${isSelected ? 'selected' : ''}" data-key="${key}"> 
                                <div class="combatant-header">
                                    <span class="combatant-name">${name}</span>
                                    <span class="combatant-type">${type}</span>
                                </div>
                                <div class="stat-bars">
                                    <div class="stat-bar"><div class="stat-bar-value hp" style="width: ${hp_perc}%;"></div><div class="stat-bar-text"><span class="label">å‘½:</span> ${hp_val} / ${hp_max}</div></div>
                                    <div class="stat-bar"><div class="stat-bar-value mp" style="width: ${mp_perc}%;"></div><div class="stat-bar-text"><span class="label">æ³•:</span> ${mp_val} / ${mp_max}</div></div>
                                </div>
                             </div>`;
                playerArea.innerHTML += barHtml; 
                playerUnitsFound++;
            });

            let enemyUnitsFound = 0;
            enemyKeys.forEach(key => {
                const unit = enemiesObj[key];
                if (typeof unit !== 'object' || unit === null) return;
                const name = SafeGetValue(unit, 'åç§°[0]', key);
                const type = 'æ•Œå†›';
                const hp_val = SafeGetValue(unit, 'ç”Ÿå‘½å€¼[0]', 0); 
                const hp_max = SafeGetValue(unit, 'ç”Ÿå‘½å€¼ä¸Šé™[0]', 100);
                const hp_perc = hp_max > 0 ? (hp_val / hp_max) * 100 : 0;
                const isSelected = (key === selectedParticipantKey); 

                let barHtml = `<div class="combatant-bar ${isSelected ? 'selected' : ''}" data-key="${key}"> 
                                <div class="combatant-header">
                                    <span class="combatant-name">${name}</span>
                                    <span class="combatant-type">${type}</span>
                                </div>
                                <div class="stat-bars">
                                    <div class="stat-bar"><div class="stat-bar-value hp" style="width: ${hp_perc}%;"></div><div class="stat-bar-text"><span class="label">å‘½:</span> ${hp_val} / ${hp_max}</div></div>
                                </div>
                             </div>`;
                enemyArea.innerHTML += barHtml; 
                enemyUnitsFound++;
            });


            if (playerUnitsFound === 0) playerArea.appendChild(playerPlaceholder.cloneNode(true)); 
            if (enemyUnitsFound === 0) enemyArea.appendChild(enemyPlaceholder.cloneNode(true)); 

            const tabContentArea = document.getElementById('tab-content-area');
            tabContentArea.innerHTML = '';
            
            document.getElementById('tab-btn-skills').classList.toggle('active-tab', currentCombatTab === 'skills');
            document.getElementById('tab-btn-bags').classList.toggle('active-tab', currentCombatTab === 'bags');

            const selectedUnitIsAlly = alliesObj.hasOwnProperty(selectedParticipantKey);
            if (selectedUnitIsAlly) {
                const { skills, items } = getParticipantData_v15(selectedParticipantKey, data);
                if (currentCombatTab === 'skills') {
                    // ã€ä¿®æ­£ 12ã€‘è¿‡æ»¤æˆ˜æ–—æŠ€èƒ½é¢æ¿ä¸­çš„ //reason
                    const skillKeys = Object.keys(skills).filter(k => k !== '$meta' && k !== '//reason');
                    if (skillKeys.length > 0) {
                        skillKeys.forEach(key => {
                            const skill = skills[key];
                            if (typeof skill !== 'object' || skill === null) return;
                            const name = SafeGetValue(skill, 'åç§°[0]', key);
                            const cost = SafeGetValue(skill, 'cost[0]', 'æ— æ¶ˆè€—');
                            const desc = SafeGetValue(skill, 'æè¿°[0]', 'æš‚æ— æè¿°ã€‚');
                            tabContentArea.innerHTML += `<button class="action-item-button" onclick="window.battle_ui_events.useSkill('${name}', '${key}')"><div><div class="action-item-name">${name}</div><div class="action-item-desc">${desc}</div></div><div class="action-item-cost">${cost}</div></button>`;
                        });
                    } else { tabContentArea.innerHTML = '<p class="empty-state-text">(æœªä¹ å¾—å¥¥ç¾©)</p>'; }
                } else { 
                    // ã€ä¿®æ­£ 13ã€‘è¿‡æ»¤æˆ˜æ–—ç‰©å“é¢æ¿ä¸­çš„ //reason
                    const bagKeys = Object.keys(items).filter(k => k !== '$meta' && k !== '//reason');
                    if (bagKeys.length > 0) {
                        let itemsFound = 0;
                        bagKeys.forEach(key => {
                            const item = items[key];
                            if (typeof item !== 'object' || item === null) return;
                            const name = SafeGetValue(item, 'åç§°[0]', key);
                            const count = SafeGetValue(item, 'æ•°é‡[0]', 0);
                            const desc = SafeGetValue(item, 'æè¿°[0]', 'æš‚æ— æè¿°ã€‚');
                            if (count <= 0) return; 
                            tabContentArea.innerHTML += `<button class="action-item-button" onclick="window.battle_ui_events.useItem('${name}', '${key}')"><div><div class="action-item-name">${name}</div><div class="action-item-desc">${desc}</div></div><div class="action-item-count">x ${count}</div></button>`;
                            itemsFound++;
                        });
                        if (itemsFound === 0) { tabContentArea.innerHTML = '<p class="empty-state-text">(æ¬¡å…ƒè¢‹ç©ºç©ºå¦‚ä¹Ÿ)</p>'; }
                    } else { tabContentArea.innerHTML = '<p class="empty-state-text">(æ¬¡å…ƒè¢‹ç©ºç©ºå¦‚ä¹Ÿ)</p>'; }
                }
            } else {
                tabContentArea.innerHTML = '<p class="empty-state-text">(æ— æ³•æ¢çŸ¥æ•Œäººçš„è¡ŒåŠ¨...)</p>';
            }

            const preInputEl = document.getElementById('pre-input-bar');
            const logEl = document.getElementById('battle-log-content');
            
            if (preInputEl.value.trim() === '') { preInputEl.value = ""; } 
            
            let combatLog = SafeGetValue(data, 'æˆ˜æ–—çŠ¶æ€[0].combat_log', []); 
            if (Array.isArray(combatLog) && combatLog.length > 0 && !Array.isArray(combatLog[0])) {
                 combatLog = [SafeGetValue(data, 'æˆ˜æ–—çŠ¶æ€[0].combat_log[0]', '(æˆ˜æ–—æ—¥å¿—)')];
            } else if (!Array.isArray(combatLog)) {
                 combatLog = [String(combatLog)];
            }
            logEl.innerHTML = combatLog.length > 0 ? combatLog.slice(-10).map(log => `<p>${log}</p>`).join('') : `<p class="empty-state-text">(æˆ˜å†µ...ä¸€ç‰‡å¯‚é™...)</p>`;
            
            logEl.scrollTop = logEl.scrollHeight;
            
            const endBattleOverlay = document.getElementById('end-battle-overlay');
            const uiMode = SafeGetValue(data, 'UIçŠ¶æ€.å½“å‰ç•Œé¢[0]', 'æ—¥å¸¸'); 
            if (uiMode === 'æˆ˜æ–—' && enemyKeys.length === 0 && allyKeys.length > 0) { endBattleOverlay.classList.remove('hidden'); } 
            else { endBattleOverlay.classList.add('hidden'); }
        }

        // --- [ 5. ä¸»æ¸²æŸ“è·¯ç”± ] ---
        function Master_Render_UI(data) {
            if (!data || typeof data !== 'object') {
                console.warn("[RoyalUI V17] Master_Render_UI æ”¶åˆ°æ— æ•ˆæ•°æ®ã€‚");
                return;
            }
            window.last_stat_data = data; 
            
            const uiMode = SafeGetValue(data, 'UIçŠ¶æ€.å½“å‰ç•Œé¢[0]', 'æ—¥å¸¸');
            
            setToggle('chessboard-container-wrapper', uiMode === 'æ—¥å¸¸');
            setToggle('battle-ui-wrapper', uiMode === 'æˆ˜æ–—');
            
            document.body.classList.toggle('status-mode', uiMode === 'æ—¥å¸¸');
            document.body.classList.toggle('combat-mode', uiMode === 'æˆ˜æ–—');

            if (uiMode === 'æ—¥å¸¸') {
                renderStatusUI(data); 
            } else {
                renderBattleUI(data); 
            }
        }

        // --- [ 6. æ ¸å¿ƒåˆå§‹åŒ– ] ---
        async function Master_Init() {
            console.log("--- [RoyalUI V17] Master_Init å¯åŠ¨ ---");
            try {
                const hasChat = typeof getChatMessages === 'function' && typeof getCurrentMessageId === 'function';
                const msgs = hasChat ? await getChatMessages(getCurrentMessageId()) : []; 
                const data = msgs?.[0]?.data?.stat_data; 
                
                let mergedData;
                if (data && typeof data === 'object') {
                    console.log("[RoyalUI V17] å‘ç° stat_dataã€‚ä¸é»˜è®¤å€¼åˆå¹¶ã€‚");
                    mergedData = deepMerge(defaultEmptyState, data); 
                } else {
                    mergedData = defaultEmptyState;
                }
                
                Master_Render_UI(mergedData); 
                console.log("--- [RoyalUI V17] Master_Init å®Œæˆ ---");
                
                document.addEventListener('click', function(event) {
                    const target = event.target;
                    const combatWrapper = document.getElementById('battle-ui-wrapper');
                    
                    if (combatWrapper && !combatWrapper.classList.contains('hidden')) {
                        const combatantBar = target.closest('.combatant-bar[data-key]');
                        if (combatantBar) {
                            const newKey = combatantBar.dataset.key;
                            if (newKey !== selectedParticipantKey) {
                                console.log("[MasterUI] åˆ‡æ¢æˆ˜æ–—ç›®æ ‡ (æœ¬åœ°):", newKey);
                                selectedParticipantKey = newKey;
                                renderBattleUI(window.last_stat_data); 
                            }
                            return; 
                        }
                    }

                    const statusContainerVisible = !document.getElementById('chessboard-container-wrapper')?.classList.contains('hidden');
                    if (statusContainerVisible) {
                        const filterBtn = target.closest('.filter-btn[data-filter-type]'); 
                        if (filterBtn) { const filterType = filterBtn.dataset.filterType; const filterValue = filterBtn.dataset.filterValue; if (filterType === 'inventory') { currentInventoryFilter = filterValue; populateAssets(SafeGetValue(window.last_stat_data, 'è´¢äº§', {})); } return; }
                        
                        const actionTargetNonCombat = target.closest('.action-button[data-action]'); 
                        if (actionTargetNonCombat) { const action = actionTargetNonCombat.dataset.action; const location = actionTargetNonCombat.dataset.location; const itemNameNonCombat = actionTargetNonCombat.dataset.itemName; if (action === 'travel' && location) { sendCommand(`/send å‰å¾€ ${location} |/trigger`); return; } else if (action === 'update-news') { sendCommand(`/send æ›´æ–°\"æ¯æ—¥æ–°é—»\" |/trigger`); return; } }
                        
                        const protagonistTab = target.closest('.protagonist-tab[data-tab]'); 
                        if (protagonistTab) { const newTab = protagonistTab.dataset.tab; if (newTab !== currentProtagonistTab) { currentProtagonistTab = newTab; populateProtagonist(SafeGetValue(window.last_stat_data, 'ä¸»è§’', {})); } return; }
                    }
                });

            } catch (e) {
                console.error('CRITICAL Error during [RoyalUI V17] Master_Init:', e);
                const wrapper = document.getElementById('chessboard-container-wrapper');
                if(wrapper) wrapper.innerHTML = `<p style='color:red;'>çŠ¶æ€æ åŠ è½½å‡ºé”™: ${e.message}</p>`;
            }
        }
        
        // --- [ 7. æ ¸å¿ƒäº‹ä»¶ç›‘å¬ ] ---
        if (typeof waitGlobalInitialized === 'function') {
            console.log("[RoyalUI V17] ç­‰å¾… Mvu åˆå§‹åŒ–...");
            waitGlobalInitialized('Mvu').then(() => {
                console.log("[RoyalUI V17] Mvu å·²åˆå§‹åŒ–. è°ƒç”¨ Master_Init å¹¶è®¾ç½® *å”¯ä¸€* ç›‘å¬å™¨ã€‚");
                Master_Init(); 
                
                eventOn(Mvu.events.VARIABLE_UPDATE_ENDED, m => {
                    if (m && m.stat_data && typeof m.stat_data === 'object') {
                        Master_Render_UI(m.stat_data); 
                    }
                });
            }).catch(error => {
                console.error('[RoyalUI V17] ç­‰å¾… Mvu åˆå§‹åŒ–æ—¶å‡ºé”™:', error);
                document.addEventListener('DOMContentLoaded', Master_Init);
            });
        } else {
            console.warn('[RoyalUI V17] waitGlobalInitialized æœªæ‰¾åˆ°ã€‚åœ¨ DOMContentLoaded ä¸ŠåŠ è½½ã€‚');
            document.addEventListener('DOMContentLoaded', Master_Init);
        }
        
    })();
</script>
</body>
</html>
```
